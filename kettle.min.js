// kettle-js v0.1.0 
// (c) 2013 Sergey Melnikov 

// kettle-js may be freely distributed under the MIT license


(function(){"use strict";function e(e){return e&&Object.prototype.hasOwnProperty.call(e.constructor.prototype,"hasOwnProperty")}function t(e){throw Error("Kettle : "+e)}function n(){var t,i,s,r,o=arguments[0];for(t=1,i=arguments.length;i>t;t++)for(s in arguments[t])r=arguments[t][s],e(r)?o[s]=n(_.isObject(o[s])?o[s]:{},r):_.isArray(r)?(_.isArray(o[s])||(o[s]=[]),o[s].push.apply(o[s],r)):o[s]=r;return o}function i(e){var t,n,i=!1;return function(){t=arguments,n=this,i||(i=!0,setTimeout(function(){e.apply(n,t),n=t=null,i=!1},0))}}function s(e,t){return function(){e.apply(t,arguments)}}function r(n,i){return e(n)||_.isArray(n)?_.isFunction(i)?new i(n):(t("No constructor set for event."),void 0):n}var o,u=this,l=u.Kettle,a=Backbone.Model.extend,c=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s+|\s+$/g)};o="undefined"!=typeof exports?exports:u.Kettle={};var h={init:function(){return Backbone.history.on("route",function(e,t,n){this._lastRoute={router:e,name:t,args:n}},this),this},bindEvent:function(e,t,n,i,s){_.isElement(e)?E.addEvent(e,n,this._proxy(i,t)):e.on(s?n+":"+s:n,i,t)},unbindEvent:function(e,t,n,i,s){_.isElement(e)?E.removeEvent(e,n,this._unproxy(i,t)):e.off(s?n+":"+s:n,i,t)},bootstrap:function(e,t,n){e instanceof Backbone.Model?this._bootstrapModel(e,t,n):e instanceof Backbone.Collection?this._bootstrapCollection(e,t,n):e instanceof Backbone.Router&&this._bootstrapRouter(e,t,n)},_bootstrapModel:function(e,t,n){var i,s,r,o=e.collection,u={bootstrap:!0};if(n.change)for(i=0,s=n.change.length;s>i;i++)r=n.change[i],r.attribute?r.fn.call(t,e,e.attributes[r.attribute],u):r.fn.call(t,e,u);if(o&&n.add)for(i=0,s=n.add.length;s>i;i++)n.add[i].fn.call(t,e,o,u);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"change",e,u)},_bootstrapCollection:function(e,t,n){var i,s,r={bootstrap:!0};if(n.reset)for(i=0,s=n.reset.length;s>i;i++)n.reset[i].fn.call(t,e,r);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"reset",e,r)},_bootstrapRouter:function(e,t,n){var i=this._lastRoute;e===i.router&&n.route&&_.each(n.route,function(e){e.attribute===i.name?e.fn.apply(t,i.args):null==e.attribute&&e.fn.call(t,i.router,i.name,i.args)})},_lastRoute:{},_fid:0,_proxies:{},_proxy_key:"__kettle_fid__",_proxy:function(e,t){var n,i=this._proxy_key;return null!=e[i]&&null!=t[i]&&(n=this._proxies[e[i]+" "+t[i]]),n||(n=s(e,t),null!=e[i]||(e[i]=this._fid++),null!=t[i]||(t[i]=this._fid++),this._proxies[e[i]+" "+t[i]]=n),n},_unproxy:function(e,t){var n=this._proxy_key,i=e[n]+" "+t[n],s=this._proxies[i];return delete this._proxies[i],s}}.init(),d=function(e){this.eventObjects={},this.subscriptions={},this.context=e};_.extend(d.prototype,{add:function(e,t){var n,i,s,r,o,u,l=this.context,a=this.subscriptions[e];this.eventObjects[e]||(this.eventObjects[e]=[]),n=this.eventObjects[e],n.push(t);for(s in a)for(i=a[s],o=0,u=i.length;u>o;o++)r=i[o],h.bindEvent(t,l,s,r.fn,r.attribute);return this},bootstrap:function(){var e,t,n,i,s,r=this.context,o=0===arguments.length?this.subscriptions:_.pick(this.subscriptions,_.toArray(arguments));for(i in o)if(n=o[i],s=this.eventObjects[i])for(e=0,t=s.length;t>e;e++)h.bootstrap(s[e],r,n);return this},hasSubscription:function(e,t){return!(!this.subscriptions[e]||void 0!==t&&!this.subscriptions[e][t])},remove:function(e,t){var n,i,s,r=this.eventObjects[e];return r&&(s=_.indexOf(r,t),i=this.context,s>=0&&(r.splice(s,1),_.each(this.subscriptions[e],function(e,s){for(var r=0,o=e.length;o>r;r++)n=e[r],h.unbindEvent(t,i,s,n.fn,n.attribute)})),0===r.length&&delete this.eventObjects[e]),this},subscribe:function(e,t,n){var i,s,r,o,u=this.eventObjects[e],l=this.context,a=t.split(":");if(t=a[0],i=a[1],this.subscriptions[e]||(this.subscriptions[e]={}),s=this.subscriptions[e],s[t]||(s[t]=[]),s[t].push({fn:n,attribute:i}),u)for(r=0,o=u.length;o>r;r++)h.bindEvent(u[r],l,t,n,i);return this},unsubscribe:function(e,t,n){var i,s,r,o,u,l,a,c=this.subscriptions,d=this.context,b=this.eventObjects;return t&&(a=t.split(":"),t=a[0],l=a[1]),_.each(c,function(a,v){e&&e!==v||(_.each(a,function(e,c){if(!t||c===t){for(i=0,s=e.length;s>i;i++){if(u=e[i],!(n&&n!==u.fn||t&&l&&l!==u.attribute))for(r=0,o=b[v].length;o>r;r++)h.unbindEvent(b[v][r],d,c,u.fn,u.attribute);e.splice(i,1),i--,s--}0===e.length&&delete a[c]}}),_.isEmpty(a)&&delete c[v])}),this}});var b=_.extend({_addViewEventObject:function(e){var t;return this._viewsubs||(this._viewsubs=new d(this)),t=this._viewsubs,this.stopListening(e,"change",this._onViewChange),this.listenTo(e,"change",this._onViewChange),_.each(t.subscriptions,function(n,i){e.eventObjects[i]&&t.add(i,e.eventObjects[i])}),this},hasSubscriptionViews:function(e,t){return!(!this._viewsubs||!this._viewsubs.hasSubscription(e,t))},_removeViewEventObject:function(e){var t=this._viewsubs;return t&&_.each(e.eventObjects,function(e,n){t.subscriptions[n]&&t.remove(n,e)}),this.stopListening(e)},bootstrapViewSubscriptions:function(e){var t,n=this;return this._viewsubs&&(t=this._viewsubs.subscriptions,_.each(t,function(t,i){e.eventObjects[i]&&h.bootstrap(e.eventObjects[i],n,t)})),this},subscribeViews:function(e,t,n){var i,s;return this._viewsubs||(this._viewsubs=new d(this)),i=this._viewsubs,i.hasSubscription(e)||(s=this.subviews?this.subviews:this.subview?[this.subview]:[],_.each(s,function(t){t.eventObjects[e]&&i.add(e,t.eventObjects[e])})),this._viewsubs.subscribe(e,t,n),this},unsubscribeViews:function(e,t,n){return this._viewsubs&&this._viewsubs.unsubscribe(e,t,n),this},_stopListeningToViewEvents:function(){var e,t,n,i,s;if(this._viewsubs){e=this._viewsubs.eventObjects;for(s in e)for(n=0,i=e[s].length;i>n;n++)t=e[s][n],h.unbindEvent(t,this),this.stopListening(t)}return this},_onViewChange:function(e,t,n,i){var s=this._viewsubs;s.subscriptions[t]&&(null!=i&&s.remove(t,i),null!=n&&(s.add(t,n),h.bootstrap(n,this,s.subscriptions[t])))}}),v=function(e){var t=e.el;t instanceof Backbone.$?(this.el=t[0],this.$el=t):(this.el=t,Backbone.$&&(this.$el=Backbone.$(t))),this.eventObjects={el:this.el},this._subs=new d(this).add("el",this.el)};_.extend(v.prototype,Backbone.Events,{bootstrap:function(){return this._subs.bootstrap.apply(this._subs,arguments),this},initialize:function(){},get:function(e){return this.eventObjects[e]},remove:function(e){var t=e?e.silent:!1;return E.remove(this.el),this.unsubscribe(),t||this.trigger("remove",this),this.stopListening()},render:function(e){var t=e?e.silent:!1;return this.bootstrap(),t||this.trigger("render",this),this},set:function(e,n,i){var s=i?i.render:!0,r=i?i.silent:!1,o=this.eventObjects[e]||null,u=this._subs;return"el"===e&&n&&n!==this.el&&t("cannot change eventObject 'el'"),!n||!this.eventTypes[e]||n instanceof this.eventTypes[e]||t("Invalid event object set, does not pass object validaiton"),this.eventObjects[e]=n,_.contains(this.mainEventObjects,e)&&(this[e]=n),o&&u.remove(e,o),n&&u.add(e,n),s!==!1&&n&&u.bootstrap(e),r||(this.trigger("change",this,e,n,o),this.trigger("change:"+e,this,n,o)),this},subscribe:function(e,t,n){return this._subs.subscribe(e,t,n),this},unset:function(e,t){return this.set(e,null,t)},unsubscribe:function(e,t,n){return this._subs.unsubscribe(e,t,n),this},mainEventObjects:["state","collection","model"],eventTypes:{},eventObjects:null,name:null,view:null,el:null,$el:null,_subs:null}),v.extend=function(){return a.call(this,_.extend.apply(this,[].slice.call(arguments,0).reverse()))};var f=v.extend({constructor:function(e){f.__super__.constructor.call(this,e),this.elements={}},addElement:function(e,n){(!_.isString(e)||this.elements[e])&&t("name invalid or taken"),n.view&&t("Element already owned by a view"),n.view=this;for(var i in this.eventObjects)"el"!==i&&n.set(i,this.eventObjects[i],{render:!1,silent:!0});return this.elements[e]=n,this},clear:function(e){return f.__super__.clear.call(this,e),_.each(this.elements,function(t){t.clear(e)}),this},remove:function(e){return f.__super__.remove.call(this,e),_.invoke(this.elements,"remove",{silent:!0}),this.elements=null,this},render:function(e){var t,n=e?e.silent:!1,i=this.elements;this.bootstrap();for(t in i)i[t].render({silent:!0});return n||this.trigger("render",this),this},removeElement:function(e){var n;return _.isString(e)&&(n=e,e=this.elements[e]),e.view!==this&&t("can't remove, Element not owned by this view"),n||_.each(this.elements,function(t,i){t===e&&(n=i)}),n&&delete this.elements[n],e.view=null,this},set:function(e,t,n){var i=_.extend({silent:!0},n);return f.__super__.set.call(this,e,t,n),_.each(this.elements,function(n){n.set(e,t,i)}),this},elements:null}),p=v.extend({constructor:function(e){p.__super__.constructor.call(this,e),this._findFn()},val:function(e){return arguments.length?(E[this._fnName](this.el,e),this):E[this._fnName](this.el)},_findFn:function(){var e,t,n=E.getTag(this.el);"INPUT"===n?(e=E.attr(this.el,"type"),t="radio"===e||"checkbox"===e?"checked":"inputVal"):t="TEXTAREA"===n||"SELECT"===n?"inputVal":"SELECT"===n?"selectVal":"IMG"===n?"src":"text",this._fnName=t},_fnName:null}),m=v.extend(b,{constructor:function(e){m.__super__.constructor.call(this,e),this.subviews=[]},addView:function(e,t){var n=this.subviews;return null!=t||(t=n.length),n.splice(t,0,e),e.on("remove",this.removeView,this),this._addViewEventObject(e),this.insert(e,t),this.emptyView&&E.remove(this.emptyView.el),this.bootstrapViewSubscriptions(e),this},empty:function(){return this._stopListeningToViewEvents(),_.invoke(_.toArray(this.subviews),"remove"),this.subviews=[],this.emptyView&&E.append(this.el,this.emptyView.el),this},findWithEventObject:function(e,t){t||(t="model");for(var n=0,i=this.subviews.length;i>n;n++)if(this.subviews[n].eventObjects[t]===e)return this.subviews[n];return null},findWithElement:function(e){e instanceof Backbone.$&&(e=e[0]);for(var t=0,n=this.subviews.length;n>t;t++)if(this.subviews[t].el===e)return this.subviews[t];return null},insert:function(e,t){var n=E.children(this.el);return n&&n.length&&n.length!==t?E.insertBefore(this.el,e.el,n[t]):E.append(this.el,e.el),this},remove:function(){return this.empty(),m.__super__.remove.call(this),this.emptyView&&this.emptyView.remove(),this},removeView:function(e){var t=_.indexOf(this.subviews,e);return t>=0&&(this.subviews.splice(t,1),E.remove(e.el),this._removeViewEventObject(e),0===this.subviews.length&&this.emptyView&&E.append(this.el,this.emptyView.el)),this},setEmptyView:function(e){return this.emptyView=e,0===this.subviews.length&&(E.empty(this.el),E.append(this.el,this.emptyView.el)),this},bindToCollection:function(e,n,i){if(0!==this.subviews.length&&t("Cannot set target on a non-empty view collection"),this._target){var s=this._target.collection;this.unsubscribe(s,"add",this._onAdd).unsubscribe(s,"reset",this._onReset).unsubscribe(s,"remove",this._onRemove).unsubscribe(s,"sort",this._onSort)}this._target={collection:e,model:n,createView:i},this.subscribe(e,"add",this._onAdd).subscribe(e,"reset",this._onReset).subscribe(e,"remove",this._onRemove).subscribe(e,"sort",this._onSort)},_onAdd:function(e){var t=this._target.createView(e),n=this.eventObjects[this._target.collection],i=n.last()===e?null:_.indexOf(n,e);this.addView(t,i)},_onReset:function(){var e,t,n,i=this.eventObjects[this._target.collection],s=i.models;for(this.empty(),e=0,t=s.length;t>e;e++)n=this._target.createView(s[e]),this.addView(n)},_onRemove:function(e){var t=this.findWithEventObject(e,this._target.model);this.removeView(t)},_onSort:function(){if(this.autoSort){var e,t,n,i,s=this.eventObjects[this._target.collection],r=s.models;for(e=0,t=r.length;t>e;e++)n=r[e],n!==this.subviews[e].eventObjects[this._target.model]&&(i=this.findWithEventObject(n,this._target.model),E.insertBefore(this.el,i.el,E.children(this.el)[e]))}},_target:null,emptyView:null,subviews:null,autoSort:!0});_.each(["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],function(e){m.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this.subviews),_[e].apply(_,t)}});var w=v.extend(b,{constructor:function(e){w.__super__.constructor.call(this,e)},insert:function(e){return E.append(this.el,e.el),this},empty:function(){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),this},remove:function(){return this.empty(),w.__super__.remove.call(this),this},set:function(e,t,n){return this.subview&&this._synced&&"el"!==e&&"view"!==e&&this.subview.set(e,t),w.__super__.set.call(this,e,t,n)},setSubView:function(e,t){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),e.el!==this.el&&this.insert(e),this._addViewEventObject(e),t&&_.each(this.eventObjects,function(t,n){"el"!==n&&"view"!==n&&t!==e.eventObjects[n]&&e.set(n,t)}),this._synced=t,this.subview=e,this.bootstrapViewSubscriptions(e),this},subview:null,_synced:!1}),g=v.extend({setTemplate:function(e){if(e===!0)this._template=this.template(_.unescape(E.html(this.el))),E.empty(this.el);else if(_.isString(e)){var t=E.html(E.select(e));this._template=this.template(t)}else this._template=e},render:function(){return E.html(this.el,this._template(this.serialize())),this},serialize:function(){return this.model.toJSON()},template:function(e){return _.template(e)},_template:null}),y=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.eventObjects={},this.eventObjects.el=this.el,this.eventObjects.view=this,this.model&&(this.eventObjects.model=this.model),this.collection&&(this.eventObjects.collection=this.collection)},get:function(e){return this.eventObjects[e]},set:function(e,t,n){var i=this.eventObjects[e];this.eventObjects[e]=t,"model"===e?this.model=t:"collection"===e&&(this.collection=t),null!=n&&n.silent||(this.trigger("change",this,e,t,i),this.trigger("change:"+e,this,t,i))},remove:function(){Backbone.View.prototype.remove.call(this),this.trigger("remove",this)},eventObjects:null}),V=function(){function e(e,t){var n,i,s,r={},o="["+t+"]",u=E.selectAll(o,e);for(n=0,i=u.length;i>n;n++)s=u[n],r[E.attr(s,t)]=s;return r}function t(e,t,n,i,s,r){i===u&&(i=e.name),e[r](t,i?n+":"+i:n,s)}function n(e,n,i){var s,r,o;for(s=0,r=n.length;r>s;s++)o=n[s],t(e,o.name,o.event,o.attribute,o.fn,i)}function s(e,n,s){var r,o,u,l,a,c,h,d,b;for(r=0,o=n.length;o>r;r++)for(h=n[r],b=_.map(h.fn,i),u=0,l=h.bindings.length;l>u;u++)for(d=h.bindings[u],a=0,c=b.length;c>a;a++)t(e,d.name,d.event,d.attribute,b[a],s)}function r(e,t){var n,i,s,r,o,u,a,c=E.getTag(e.el);if(n=t.eventObject,i=t.attribute,r=t.domEvent,o=t.fromDOM?t.fromDOM(t):function(){this.eventObjects[n].set(i,this.val(),{origin:this.el})},u=t.fromModel?t.fromModel(t):function(e,t,n){n&&n.origin===this.el||this.val(null==t?"":t)},null==i&&(i=e.name),e.subscribe(n,"change:"+i,u),null==r&&("SELECT"===c?r="change":"TEXTAREA"===c?r="change keyup":"INPUT"===c&&(a=E.attr(e.el,"type"),r=a&&"text"!==a?"change":"change keyup")),null!=r){s=r.split(l);for(var h=0,d=s.length;d>h;h++)e.subscribe("el",s[h],o)}}var u="{name}",l=/\s+/;return{view:function(t,n){var i,s,r,u,l=n.attr,a=e(t.el,l),c=n.defaults;for(u in n.elements)r=n.elements[u],i=a[u],i&&(delete a[u],s=new r.Constructor({el:i}),s.name=u,t.addElement(u,s),r.loader&&r.loader.build(s,r.data));c&&_.each(a,function(e,n){var i=new c.Constructor({el:e});i.name=n,t.addElement(n,i),c.loader.build(i,c.data)}),o.elementLoader.build(t,n)},element:function(e,t){if(t.unknown&&_.extend(e,t.unknown),t.bindings&&n(e,t.bindings,"subscribe"),t.bindingsDebounced&&s(e,t.bindingsDebounced,"subscribe"),t.setup)for(var i=t.setup,r=0,o=i.length;o>r;r++)i[r].call(e)},domValue:function(e,t){t.bind&&r(e,t.bind),o.elementLoader.build(e,t)},containerView:function(e,t){var i=t.subview||{},r=i.set,u=i.View,l=i.synced;t.eventsviews&&n(e,t.eventsviews,"subscribeViews"),t.eventsviewsDebounced&&s(e,t.eventsviewsDebounced,"subscribeViews"),u?e.setSubView(new u({render:!1}),l):r&&e.setSubView(_.isFunction(r)?r.call(e):r,l),o.elementLoader.build(e,t)},collectionView:function(e,t){var i,r=t.subviews||{},u=r.empty;r.create?i=r.create:r.View&&(i=function(e){var t={};return t[r.model]=e,new r.View({eventObjects:t})}),r.collection&&r.model&&i&&e.bindToCollection(r.collection,r.model,i),t.eventsviews&&n(e,t.eventsviews,"subscribeViews"),t.eventsviewsDebounced&&s(e,t.eventsviewsDebounced,"subscribeViews"),u&&e.setEmptyView(_.isFunction(u)?u.call(e):u),o.elementLoader.build(e,t)},template:function(e,t){t.template&&e.setTemplate(t.template),o.elementLoader.build(e,t)}}}(),O=function(){function e(t,i){var o,u,l,a,c,h,d,v={};h=t;for(o in h)for(u=o.split(b),a=0,c=u.length;c>a;a++)l=u[a],l.indexOf(p)>=0&&(d=l.substring(0,1),(!i&&!_.contains(w,d)||d===i)&&(i&&(l=l.replace(i,"")),v[l]=r(h[o],v[l])));var f=s(t);return _.isEmpty(f)||n(v,e(f,i)),v}function i(e,t){var n,i,s,r,o,u,l,a,c,h,d,v,m=[];for(n in e)for(i=n.split(b),l=0,a=i.length;a>l;l++){if(u={},c=f.exec(i[l]),c&&c[2])for(r=c[1],s=c[2].split(b),h=0,d=s.length;d>h;h++)o=r+p+s[h],v=o.substring(0,1),(!t&&!_.contains(w,v)||v===t)&&(u.bindings||(u.bindings=[]),t&&(o=o.replace(t,"")),u.bindings.push(o));_.isEmpty(u)||(u.fn=_.isArray(e[n])?e[n]:[e[n]],m.push(u))}return m}function s(e){var t,n,i,s,o,u,l,a,c,h,d={};for(n in e)for(t=n.split(b),s=0,o=t.length;o>s;s++)if(i=v.exec(t[s]),i&&i[2])for(a=i[1],c=i[2].split(b),u=0,l=c.length;l>u;u++)h=a+p+c[u],d[h]=r(e[n],d[h]);return d}function r(e,t){var n=_.isArray(t)?t:[];return _.isArray(e)?n.push.apply(n,e):n.push(e),n}function u(e){var i,s,r,o,u,l={},a={},c=function(e,n){var s=u[o[i]];s[n]&&"bindings"!==n&&"eventsviews"!==n&&s[n]!==e&&t("ambigious merging of property: "+o[i])};for(r in e)for(o=r.split(b),u=1===o.length?l:a,i=0,s=o.length;s>i;i++)u[o[i]]?(_.each(e[r],c),u[o[i]]=n({},u[o[i]],e[r])):u[o[i]]=e[r];return n({},a,l)}function l(e){var t={},n=function(n){n[0],-1!==n.indexOf(p)||v.test(n)||f.test(n)||_.contains(g,n)||(t[n]=e[i])};for(var i in e)_.each(i.split(b),n);return t}function a(e){return _.isFunction(e)?e:_.isString(e)?function(){this[e].apply(this,arguments)}:(t("Not an acceptable value for an event method (must be a function or string"),void 0)}function c(t,n){var i=[];return _.each(e(t,n),function(e,t){var n=d(t);e=_.isArray(e)?e:[e],_.each(e,function(e){i.push(_.extend({fn:a(e)},n))})}),i}function h(e,t){var n=[];return _.each(i(e,t),function(e){var t={};t.bindings=_.map(e.bindings,d),t.fn=_.map(e.fn,a),n.push(t)}),n}function d(e){var t,n,i,s,r,o;return n=e.indexOf(p),s=e.substring(0,n),i=e.substring(n+1),i=i.split(":"),r=i[0],o=i[1],t={name:s,event:r,attribute:o}}var b=/\s+(?![^\[]*\]|[^\{]*\})/,v=/(.*?)\[(.*?)\]/,f=/(.*?)\{(.*?)\}/,p=".",m="*",w=["*"],g=["bind","subview","subviews","template","group","groups","collection","model","eventObjects","state","attr","el","defaults","elements","setup"];return{view:function(e,n){var i,s={},r={},l={},a={bind:{Constructor:o.DomValue,loader:o.domValueLoader},subview:{Constructor:o.ContainerView,loader:o.containerViewLoader},subviews:{Constructor:o.CollectionView,loader:o.collectionViewLoader},template:{Constructor:o.TemplateView,loader:o.templateViewLoader}},c=function(e){var n,i=0;return _.each(["subview","subviews","template","bind"],function(t){t in e&&(i++,n=_.extend({},a[t]),n.data=e)}),i>1?t("Only one of 'subview', 'subviews', 'template', 'bind' can exsist on an element"):0===i&&(n=_.extend({},a.bind),n.data=e),n};if(_.isObject(e))return i=_.extend({},o.elementLoader.parse(e),n),i.attr||(i.attr=o.defaultAttr),(e.defaults||o.defaultElement)&&(i.defaults=c(o.elementLoader.parse(e.defaults||o.defaultElement),n)),_.each(e.elements,function(e,t){_.isFunction(e)?l[t]={Constructor:e}:s[t]=o.elementLoader.parse(e,n)}),_.each(u(s),function(e,t){r[t]=c(e)}),s=_.extend(r,l),_.isEmpty(s)||(i.elements=s),i},element:function(e,t){var i={},s=e.group;if((_.isString(e)||_.isBoolean(e))&&(e={bind:e}),_.each(["template","attr","defaults"],function(t){void 0!==e[t]&&(i[t]=e[t])}),i.bindings=c(e),0===i.bindings.length&&delete i.bindings,i.bindingsDebounced=h(e),0===i.bindingsDebounced.length&&delete i.bindingsDebounced,i.eventsviews=c(e,m),0===i.eventsviews.length&&delete i.eventsviews,i.eventsviewsDebounced=h(e,m),0===i.eventsviewsDebounced.length&&delete i.eventsviewsDebounced,e.setup&&(i.setup=_.isArray(e.setup)?e.setup:[e.setup]),e.subviews){var r=_.isFunction(e.subviews)?{View:e.subviews}:e.subviews;i.subviews=r===!0?{}:_.extend({model:"model",collection:"collection"},r)}if(e.bind){var u,a={eventObject:"model"},d=e.bind;_.isString(d)&&(u=d.split(p),d=u.length>1?{eventObject:u[0],attribute:u[1]}:{attribute:u[0]}),i.bind=d===!0?a:_.extend(a,d)}if(e.subview){var b=_.isFunction(e.subview)?{View:e.subview}:e.subview;i.subview=b===!0?{}:_.extend({synced:!0},b)}if(i.unknown=l(e),_.isEmpty(i.unknown)&&delete i.unknown,s&&t){var v=_.map(_.isArray(s)?s:[s],function(e){return t[e]?o.elementLoader.parse(t[e],t):{}});v.push(i),i=_.foldl(v,function(e,t){var i=t.unknown;return delete t.unknown,n(e,t),i&&(e.unknown=_.extend(e.unknown||{},i)),e},{})}return i}}}(),x=function(e,t){this._parse=e,this._builder=t};_.extend(x.prototype,{add:function(e,t){return(this._addons||(this._addons=[])).push({parse:e,builder:t}),this},parse:function(e,t){var n,i,s,r,o=this._parse(e,t);if(this._addons){for(n=0,i=this._addons.length;i>n;n++)s=this._addons[n].parse(e,t),void 0!==s&&(r||(r=[])).push({buildData:s,builder:this._addons[n].builder});r&&(o.addons=r)}return o},build:function(e,t){var n,i,s;if(this._builder(e,t),t.addons)for(s=t.addons,n=0,i=s.length;i>n;n++)s[n].builder(e,s[n].buildData)},clear:function(){return this._loaders=[],this}});var j=function(t,i){return function(s){s||(s={});var u,l,c,h=s.collection,d=s.state,b=s.model,v=s.groups,f=s.eventTypes?_.extend({},s.eventTypes):{},p=s.el||this.prototype._el;return h&&_.extend(f,{collection:h}),b&&_.extend(f,{model:b}),e(d)?(c=d,f.state=Backbone.Model):d&&(f.state=d),this.prototype._groups&&(v=_.extend({},this.prototype._groups,v)),u=i.parse(s,v?_.extend({},o._groups,v):o._groups),l=u.unknown||{},delete u.unknown,this.prototype._parsed&&(u=n({},this.prototype._parsed,u)),this.prototype.eventTypes&&(f=n({},this.prototype.eventTypes,f)),this.prototype._stateParams&&(c=_.extend({},this.prototype._stateParams,c)),a.call(this,_.extend({constructor:function(n){n||(n={});var s,u=_.extend({},o._globalEventObjects,n.eventObjects),l=n.el||this._el||E.create("<div></div>"),a=o.getEl(l),c=null==n.render?!0:n.render,h=this.eventTypes;n.collection&&(u.collection=r(n.collection,h.collection)),n.model&&(u.model=r(n.model,h.model)),n.state?u.state=e(n.state)?r(_.extend(this._stateParams,n.state),h.state):r(n.state,h.state):this._stateParams&&(u.state=r(this._stateParams,h.state)),t.call(this,{el:a}),this.set("view",this),i.build(this,this._parsed);for(s in u)this.set(s,u[s],{render:!1});this.initialize.apply(this,arguments);for(s in this.elements)this.elements[s].initialize.apply(this.elements[s],arguments);c&&this.render()},eventTypes:f,_stateParams:c,_parsed:u,_el:p,_groups:v},l))}},E=function(){var e=!document.addEventListener||!document.querySelectorAll;return{clone:function(e){return e.cloneNode(!0)},select:function(t,n){return e?n?Backbone.$(n).find(t)[0]:Backbone.$(t)[0]:(n=n||document,n.querySelector(t))},selectAll:function(t,n){return e?n?Backbone.$(n).find(t):Backbone.$(t):(n=n||document,n.querySelectorAll(t))},addEvent:function(t,n,i){e?Backbone.$(t).on(n,i):t.addEventListener(n,i)},removeEvent:function(t,n,i){e?Backbone.$(t).off(n,i):t.removeEventListener(n,i)},remove:function(t){e?Backbone.$(t).detach():null!=t.parentNode&&t.parentNode.removeChild(t)},create:function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild},attr:function(e,t,n){return arguments.length>=3?(e.setAttribute(t,n),n):e.getAttribute(t)},inputVal:function(e,t){return arguments.length>=2?e.value=t:e.value},html:function(e,t){return arguments.length>=2?e.innerHTML=t:e.innerHTML},empty:function(e){E.html(e,"")},text:function(e,t){var n=void 0!==e.textContent;return arguments.length>=2?n?e.textContent=t:(Backbone.$(e).text(t),t):n?e.textContent:Backbone.$(e).text()},src:function(e,t){return arguments.length>=2?e.src=t:e.src},checked:function(e,t){return arguments.length>=2?e.checked=!!t:!!e.checked},selectVal:function(t,n){return arguments.length>=2?(e?Backbone.$(t).val(n):t.value=n,n):e?Backbone.$(t).val():t.options[t.selectedIndex].value},getTag:function(e){return e.tagName},append:function(e,t){e.appendChild(t)},insertBefore:function(e,t,n){e.insertBefore(t,n)},children:function(e){return e.childNodes}}}();_.extend(o,{VERSION:"0.1.0",defaultAttr:"data-kettle",defaultElement:null,parsers:O,builders:V,elementLoader:new x(O.element,V.element),viewLoader:new x(O.view,V.view),domValueLoader:new x(O.element,V.domValue),collectionViewLoader:new x(O.element,V.collectionView),containerViewLoader:new x(O.element,V.containerView),templateViewLoader:new x(O.element,V.template),noConflict:function(){return u.Kettle=l,this},BBView:y,View:f,CollectionView:m,Element:v,ContainerView:w,DomValue:p,Loader:x,EventListeners:d,EventInterface:h,TemplateView:g,setGroup:function(e,t){o._groups[e]=t},getGroup:function(e){return o._groups[e]},deleteGroup:function(e){delete o._groups[e]},setGlobal:function(e){var n=v.prototype.mainEventObjects;_.extend(o._globalEventObjects,e),_.each(e,function(e,i){v.prototype[i]||f.prototype[i]||w.prototype[i]||m.prototype[i]||p.prototype[i]?t("can't set a global event object with name "+i+". it's reserved on an Object prototype"):_.contains(n,i)&&t("can't set a global event object with name "+i+". it's already contained in the main events. (perhaps it's already been set)"),n.push(i)})},getGlobal:function(e){return o._globalEventObjects[e]},getEl:function(e){var n,i=this._elCache;return _.isFunction(e)?e():_.isObject(e)?e:(_.isString(e)||t("Selector must be a string!"),i[e]?n=this._elCache[e]:(n={clone:!1},n.el=E.select(e),null==n.el&&t("Element not found with selector: "+e),"SCRIPT"===E.getTag(n.el)&&(n.el=E.create(c(E.html(n.el))),n.clone=!0),i[e]=n),n.clone?E.clone(n.el):n.el)},_globalEventObjects:{},_elCache:{},_groups:{}}),v.extend=j(v,o.elementLoader),f.extend=j(f,o.viewLoader),m.extend=j(m,o.collectionViewLoader),w.extend=j(w,o.containerViewLoader),p.extend=j(p,o.domValueLoader),g.extend=j(g,o.templateViewLoader)}).call(this);