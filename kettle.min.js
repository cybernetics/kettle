// kettle-js v0.1.0 
// (c) 2013 Sergey Melnikov 

// kettle-js may be freely distributed under the MIT license


(function(){"use strict";function e(e){return e&&Object.prototype.hasOwnProperty.call(e.constructor.prototype,"hasOwnProperty")}function t(e){throw Error("Kettle : "+e)}function n(){var t,i,s,o,r=arguments[0];for(t=1,i=arguments.length;i>t;t++)for(s in arguments[t])o=arguments[t][s],e(o)?r[s]=n(_.isObject(r[s])?r[s]:{},o):_.isArray(o)?(_.isArray(r[s])||(r[s]=[]),r[s].push.apply(r[s],o)):r[s]=o;return r}function i(e){var t,n,i=!1;return function(){t=arguments,n=this,i||(i=!0,setTimeout(function(){e.apply(n,t),n=t=null,i=!1},0))}}function s(n,i){return e(n)||_.isArray(n)?_.isFunction(i)?new i(n):(t("No constructor set for event."),void 0):n}var o,r=this,u=r.Kettle,l=Backbone.Model.extend,c=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s+|\s+$/g)};o="undefined"!=typeof exports?exports:r.Kettle={};var a={init:function(){return Backbone.history.on("route",function(e,t,n){this._lastRoute={router:e,name:t,args:n}},this),this},bindEvent:function(e,t,n,i,s){e instanceof Backbone.$?e.on(n,this._proxy(i,t)):e.on(s?n+":"+s:n,i,t)},unbindEvent:function(e,t,n,i,s){e instanceof Backbone.$?i?e.off(n,this._unproxy(i,t)):e.off(n):e.off(s?n+":"+s:n,i,t)},bootstrap:function(e,t,n){e instanceof Backbone.Model?this._bootstrapModel(e,t,n):e instanceof Backbone.Collection?this._bootstrapCollection(e,t,n):e instanceof Backbone.Router&&this._bootstrapRouter(e,t,n)},_bootstrapModel:function(e,t,n){var i,s,o,r=e.collection,u={bootstrap:!0};if(n.change)for(i=0,s=n.change.length;s>i;i++)o=n.change[i],o.attribute?o.fn.call(t,e,e.attributes[o.attribute],u):o.fn.call(t,e,u);if(r&&n.add)for(i=0,s=n.add.length;s>i;i++)n.add[i].fn.call(t,e,r,u);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"change",e,u)},_bootstrapCollection:function(e,t,n){var i,s,o={bootstrap:!0};if(n.reset)for(i=0,s=n.reset.length;s>i;i++)n.reset[i].fn.call(t,e,o);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"reset",e,o)},_bootstrapRouter:function(e,t,n){var i=this._lastRoute;e===i.router&&n.route&&_.each(n.route,function(e){e.attribute===i.name?e.fn.apply(t,i.args):null==e.attribute&&e.fn.call(t,i.router,i.name,i.args)})},_lastRoute:{},_fid:0,_proxies:{},_proxy_key:"__kettle_fid__",_proxy:function(e,t){var n,i=this._proxy_key;return null!=e[i]&&null!=t[i]&&(n=this._proxies[e[i]+" "+t[i]]),n||(n=_.bind(e,t),null!=e[i]||(e[i]=this._fid++),null!=t[i]||(t[i]=this._fid++),this._proxies[e[i]+" "+t[i]]=n),n},_unproxy:function(e,t){var n=this._proxy_key,i=e[n]+" "+t[n],s=this._proxies[i];return delete this._proxies[i],s}}.init(),h=function(e){this.eventObjects={},this.subscriptions={},this.context=e};_.extend(h.prototype,{add:function(e,t){var n,i=this.context;return this.eventObjects[e]||(this.eventObjects[e]=[]),n=this.eventObjects[e],n.push(t),_.each(this.subscriptions[e],function(e,n){_.each(e,function(e){a.bindEvent(t,i,n,e.fn,e.attribute)})}),this},bootstrap:function(){var e=this.eventObjects,t=this.context,n=0===arguments.length?this.subscriptions:_.pick(this.subscriptions,_.toArray(arguments));return _.each(n,function(n,i){_.each(e[i],function(e){a.bootstrap(e,t,n)})}),this},hasSubscription:function(e,t){return!(!this.subscriptions[e]||void 0!==t&&!this.subscriptions[e][t])},remove:function(e,t){var n,i,s,o=this.eventObjects[e];return o&&(s=_.indexOf(o,t),i=this.context,s>=0&&(o.splice(s,1),_.each(this.subscriptions[e],function(e,s){for(var o=0,r=e.length;r>o;o++)n=e[o],a.unbindEvent(t,i,s,n.fn,n.attribute)})),0===o.length&&delete this.eventObjects[e]),this},subscribe:function(e,t,n){var i,s,o=this.context,r=t.split(":");return t=r[0],i=r[1],this.subscriptions[e]||(this.subscriptions[e]={}),s=this.subscriptions[e],s[t]||(s[t]=[]),s[t].push({fn:n,attribute:i}),_.each(this.eventObjects[e],function(e){a.bindEvent(e,o,t,n,i)}),this},unsubscribe:function(e,t,n){var i,s,o,r,u,l,c,h=this.subscriptions,b=this.context,d=this.eventObjects;return t&&(c=t.split(":"),t=c[0],l=c[1]),_.each(h,function(c,v){e&&e!==v||(_.each(c,function(e,h){if(!t||h===t){for(i=0,s=e.length;s>i;i++){if(u=e[i],!(n&&n!==u.fn||t&&l&&l!==u.attribute))for(o=0,r=d[v].length;r>o;o++)a.unbindEvent(d[v][o],b,h,u.fn,u.attribute);e.splice(i,1),i--,s--}0===e.length&&delete c[h]}}),_.isEmpty(c)&&delete h[v])}),this}});var b=_.extend({_addViewEventObject:function(e){var t;return this._viewsubs||(this._viewsubs=new h(this)),t=this._viewsubs,this.stopListening(e,"change",this._onViewChange),this.listenTo(e,"change",this._onViewChange),_.each(t.subscriptions,function(n,i){e.eventObjects[i]&&t.add(i,e.eventObjects[i])}),this},hasSubscriptionViews:function(e,t){return!(!this._viewsubs||!this._viewsubs.hasSubscription(e,t))},_removeViewEventObject:function(e){var t=this._viewsubs;return t&&_.each(e.eventObjects,function(e,n){t.subscriptions[n]&&t.remove(n,e)}),this.stopListening(e,"change",this._onViewChange)},bootstrapViewSubscriptions:function(e){var t,n=this;return this._viewsubs&&(t=this._viewsubs.subscriptions,_.each(t,function(t,i){e.eventObjects[i]&&a.bootstrap(e.eventObjects[i],n,t)})),this},subscribeViews:function(e,t,n){var i,s;return this._viewsubs||(this._viewsubs=new h(this)),i=this._viewsubs,i.hasSubscription(e)||(s=this.subviews?this.subviews:this.subview?[this.subview]:[],_.each(s,function(t){t.eventObjects[e]&&i.add(e,t.eventObjects[e])})),this._viewsubs.subscribe(e,t,n),this},unsubscribeViews:function(e,t,n){return this._viewsubs&&this._viewsubs.unsubscribe(e,t,n),this},_stopListeningToViewEvents:function(){var e,t,n,i;if(this._viewsubs){e=this._viewsubs.eventObjects;for(i in e)for(t=0,n=e[i].length;n>t;t++)a.unbindEvent(e[i][t],this)}return this.stopListening(null,"change",this._onViewChange),this},_onViewChange:function(e,t,n,i){var s=this._viewsubs;s.subscriptions[t]&&(null!=i&&s.remove(t,i),null!=n&&(s.add(t,n),a.bootstrap(n,this,s.subscriptions[t])))}}),d=function(e){var t=e.el;t instanceof Backbone.$?(this.el=t[0],this.$el=t):(this.el=t,this.$el=Backbone.$(t)),this.eventObjects={el:this.$el,view:this},this._subs=new h(this).add("el",this.$el).add("view",this)};_.extend(d.prototype,Backbone.Events,{bootstrap:function(){return this._subs.bootstrap.apply(this._subs,arguments),this},initialize:function(){},get:function(e){return this.eventObjects[e]},remove:function(e){var t=e?e.silent:!1;return this.$el.remove(),this.unsubscribe(),t||this.trigger("remove",this),this.off().stopListening()},render:function(e){var t=e?e.silent:!1;return this.bootstrap(),t||this.trigger("render",this),this},set:function(e,n,i){var s=i?i.render:!0,o=i?i.silent:!1,r=this.eventObjects[e]||null,u=this._subs;return"el"===e&&n&&n!==this.$el&&t("cannot change eventObject 'el'"),!n||!this.eventTypes[e]||n instanceof this.eventTypes[e]||t("Invalid event object set, does not pass object validaiton"),this.eventObjects[e]=n,_.contains(this.mainEventObjects,e)&&(this[e]=n),r&&u.remove(e,r),n&&u.add(e,n),s!==!1&&n&&u.bootstrap(e),o||(this.trigger("change",this,e,n,r),this.trigger("change:"+e,this,n,r)),this},subscribe:function(e,t,n){return this._subs.subscribe(e,t,n),this},unset:function(e,t){return this.set(e,null,t)},unsubscribe:function(e,t,n){return this._subs.unsubscribe(e,t,n),this},mainEventObjects:["state","collection","model"],eventTypes:{},eventObjects:null,name:null,view:null,el:null,$el:null,_subs:null}),d.extend=function(){return l.call(this,_.extend.apply(this,[].slice.call(arguments,0).reverse()))};var v=d.extend({constructor:function(e){v.__super__.constructor.call(this,e),this.elements={}},addElement:function(e,n){(!_.isString(e)||this.elements[e])&&t("name invalid or taken"),n.view&&t("Element already owned by a view"),n.view=this;for(var i in this.eventObjects)"el"!==i&&n.set(i,this.eventObjects[i],{render:!1,silent:!0});return this.elements[e]=n,this},clear:function(e){return v.__super__.clear.call(this,e),_.each(this.elements,function(t){t.clear(e)}),this},remove:function(e){return v.__super__.remove.call(this,e),_.invoke(this.elements,"remove",{silent:!0}),this.elements=null,this},render:function(e){var t=e?e.silent:!1;return this.bootstrap(),_.invoke(this.elements,"render",{silent:!0}),t||this.trigger("render",this),this},removeElement:function(e){var n;return _.isString(e)&&(n=e,e=this.elements[e]),e.view!==this&&t("can't remove, Element not owned by this view"),n||_.each(this.elements,function(t,i){t===e&&(n=i)}),n&&delete this.elements[n],e.view=null,this},set:function(e,t,n){var i=_.extend({silent:!0},n);return v.__super__.set.call(this,e,t,n),_.each(this.elements,function(n){n.set(e,t,i)}),this},elements:null}),f=d.extend({constructor:function(e){f.__super__.constructor.call(this,e),this._findFn()},val:function(e){return arguments.length?(this._set(e),this):this._get()},_valGet:function(){return this.el.value},_valSet:function(e){this.el.value=e},_textGetIE:function(){return this.el.innerText},_textSetIE:function(e){this.el.innerText=e},_textGet:function(){return this.el.textContent},_textSet:function(e){this.el.textContent=e},_checkboxGet:function(){return!!this.el.checked},_checkboxSet:function(e){this.el.checked=!!e},_imgGet:function(){return this.el.src},_imgSet:function(e){this.el.src=e},_selectGet:function(){return this.$el.val()},_selectSet:function(e){this.$el.val(e)},_get:function(){},_set:function(){},_findFn:function(){var e=this.el.tagName,t=this.el.getAttribute("type");"INPUT"!==e||"radio"!==t&&"checkbox"!==t?"INPUT"===e||"TEXTAREA"===e||"SELECT"===e?(this._get=this._valGet,this._set=this._valSet):"IMG"===e?(this._get=this._imgGet,this._set=this._imgSet):void 0!==this.el.textContent?(this._get=this._textGet,this._set=this._textSet):(this._get=this._textGetIE,this._set=this._textSetIE):(this._get=this._checkboxGet,this._set=this._checkboxSet)}}),p=d.extend(b,{constructor:function(e){p.__super__.constructor.call(this,e),this.subviews=[]},addView:function(e,t){var n=this.subviews;return _.contains(n,e)?this.removeView(e).addView(e,t):(null!=t||(t=n.length),n.splice(t,0,e),e.on("remove",this.removeView,this),this._addViewEventObject(e),this.insert(e,t),this.emptyView&&this.emptyView.$el.detach(),this.bootstrapViewSubscriptions(e)),this},empty:function(){return this._stopListeningToViewEvents(),_.invoke(_.toArray(this.subviews),"remove"),this.subviews=[],this.emptyView&&this.$el.append(this.emptyView.$el),this},findWithEventObject:function(e,t){t||(t="model");for(var n=0,i=this.subviews.length;i>n;n++)if(this.subviews[n].eventObjects[t]===e)return this.subviews[n];return null},findWithElement:function(e){e instanceof Backbone.$&&(e=e[0]);for(var t=0,n=this.subviews.length;n>t;t++)if(this.subviews[t].el===e)return this.subviews[t];return null},insert:function(e,t){var n=this.el.childNodes;return n&&n.length&&n.length!==t?this.el.insertBefore(e.el,n[t]):this.el.appendChild(e.el),this},remove:function(){return this.empty(),p.__super__.remove.call(this),this.emptyView&&this.emptyview.remove(),this},removeView:function(e){var t=_.indexOf(this.subviews,e);return t>=0&&(this.subviews.splice(t,1),e.$el.detach(),this._removeViewEventObject(e),0===this.subviews.length&&this.emptyView&&this.$el.append(this.emptyView.$el)),this},setEmptyView:function(e){return this.emptyView=e,0===this.subviews.length&&this.$el.empty().append(this.emptyView.$el),this},bindToCollection:function(e,n,i){if(0!==this.subviews.length&&t("Cannot set target on a non-empty view collection"),this._target){var s=this._target.collection;this.unsubscribe(s,"add",this._onAdd).unsubscribe(s,"reset",this._onReset).unsubscribe(s,"remove",this._onRemove).unsubscribe(s,"sort",this._onSort)}this._target={collection:e,model:n,createView:i},this.subscribe(e,"add",this._onAdd).subscribe(e,"reset",this._onReset).subscribe(e,"remove",this._onRemove).subscribe(e,"sort",this._onSort)},_onAdd:function(e){var t=this._target.createView(e),n=this.eventObjects[this._target.collection],i=n.last()===e?null:_.indexOf(n,e);this.addView(t,i)},_onReset:function(){var e,t,n=this.eventObjects[this._target.collection],i=n.models,s={};for(this.empty(),e=0,t=i.length;t>e;e++)s.at=e,this._onAdd(i[e],s)},_onRemove:function(e){var t=this.findWithEventObject(e,this._target.model);this.removeView(t)},_onSort:function(){if(this.autoSort){var e,t,n,i,s=this.eventObjects[this._target.collection],o=s.models;for(e=0,t=o.length;t>e;e++)n=o[e],n!==this.subviews[e].eventObjects[this._target.model]&&(i=this.findWithEventObject(n,this._target.model),this.$el.children().eq(e).before(i.$el))}},_target:null,emptyView:null,subviews:null,autoSort:!0});_.each(["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],function(e){p.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this.subviews),_[e].apply(_,t)}});var m=d.extend(b,{constructor:function(e){m.__super__.constructor.call(this,e)},insert:function(e){return this.$el.append(e.$el),this},empty:function(){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),this},remove:function(){return this.empty(),m.__super__.remove.call(this),this},set:function(e,t,n){return this.subview&&this._synced&&"el"!==e&&"view"!==e&&this.subview.set(e,t),m.__super__.set.call(this,e,t,n)},setSubView:function(e,t){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),e.el!==this.el&&this.insert(e),this._addViewEventObject(e),t&&_.each(this.eventObjects,function(t,n){"el"!==n&&"view"!==n&&t!==e.eventObjects[n]&&e.set(n,t)}),this._synced=t,this.subview=e,this.bootstrapViewSubscriptions(e),this},subview:null,_synced:!1}),w=d.extend({setTemplate:function(e){e===!0?(this._template=this.template(_.unescape(this.el.innerHTML)),this.el.innerHTML=""):this._template=_.isString(e)?this.template(Backbone.$(e).html()):e},render:function(){return this.el.innerHTML=this._template(this.serialize()),this},serialize:function(){return this.model.toJSON()},template:function(e){return _.template(e)},_template:null}),g=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.eventObjects={},this.eventObjects.el=this.$el,this.eventObjects.view=this,this.model&&(this.eventObjects.model=this.model),this.collection&&(this.eventObjects.collection=this.collection)},get:function(e){return this.eventObjects[e]},set:function(e,t,n){var i=this.eventObjects[e];this.eventObjects[e]=t,"model"===e?this.model=t:"collection"===e&&(this.collection=t),null!=n&&n.silent||(this.trigger("change",this,e,t,i),this.trigger("change:"+e,this,t,i))},remove:function(){Backbone.View.prototype.remove.call(this),this.trigger("remove",this)},eventObjects:null}),y=function(){function e(e,t,n,i,s){c||(c=[],setTimeout(function(){_.each(c,function(e){e.obj[e.subFn](e.eventName,e.event,e.fn)}),c=null},0)),c.push({obj:e,subFn:t,fn:s,eventName:n,event:i})}function t(e,t){var n={},i="["+t+"]";return _.each(document.querySelectorAll?e[0].querySelectorAll(i):e.eq(0).find(i),function(e){n[e.getAttribute(t)]=e}),n}function n(t,n,i,s,o,r){s===l&&(s=t.name),"el"===n?e(t,r,n,i,o):t[r](n,s?i+":"+s:i,o)}function s(e,t,i){var s,o,r;for(s=0,o=t.length;o>s;s++)r=t[s],n(e,r.name,r.event,r.attribute,r.fn,i)}function r(e,t,s){var o,r,u,l,c,a,h,b,d;for(o=0,r=t.length;r>o;o++)for(h=t[o],d=_.map(h.fn,i),u=0,l=h.bindings.length;l>u;u++)for(b=h.bindings[u],c=0,a=d.length;a>c;c++)n(e,b.name,b.event,b.attribute,d[c],s)}function u(t,n){var i,s,o,r,u,c=t.el.tagName;i=n.eventObject,s=n.attribute,o=n.domEvent,r=n.fromDOM?n.fromDOM(n):function(){this.eventObjects[i].set(s,this.val(),{origin:this.el})},u=n.fromModel?n.fromModel(n):function(e,t,n){n&&n.origin===this.el||this.val(null==t?"":t)},s===l&&(s=t.name),t.subscribe(i,"change:"+s,u),("INPUT"===c||"TEXTAREA"===c||"SELECT"===c)&&e(t,"subscribe","el",o,r)}var l="{name}",c=null;return{view:function(e,n){var i=n.attr,s=t(e.$el,i),r=n.defaults;_.each(n.elements,function(t,n){var i,o;i=s[n],i&&(delete s[n],o=new t.Constructor({el:i}),o.name=n,e.addElement(n,o),t.loader&&t.loader.build(o,t.data))}),r&&_.each(s,function(t,n){var i=new r.Constructor({el:t});i.name=n,e.addElement(n,i),r.loader.build(i,r.data)}),o.elementLoader.build(e,n)},element:function(e,t){if(t.unknown&&_.extend(e,t.unknown),t.bindings&&s(e,t.bindings,"subscribe"),t.bindingsDebounced&&r(e,t.bindingsDebounced,"subscribe"),t.setup)for(var n=t.setup,i=0,o=n.length;o>i;i++)n[i].call(e)},domValue:function(e,t){t.bind&&u(e,t.bind),o.elementLoader.build(e,t)},containerView:function(e,t){var n=t.subview||{},i=n.set,u=n.View,l=n.synced;t.eventsviews&&s(e,t.eventsviews,"subscribeViews"),t.eventsviewsDebounced&&r(e,t.eventsviewsDebounced,"subscribeViews"),u?e.setSubView(new u({render:!1}),l):i&&e.setSubView(_.isFunction(i)?i.call(e):i,l),o.elementLoader.build(e,t)},collectionView:function(e,t){var n,i=t.subviews||{},u=i.empty;i.create?n=i.create:i.View&&(n=function(e){var t={};return t[i.model]=e,new i.View({eventObjects:t})}),i.collection&&i.model&&n&&e.bindToCollection(i.collection,i.model,n),t.eventsviews&&s(e,t.eventsviews,"subscribeViews"),t.eventsviewsDebounced&&r(e,t.eventsviewsDebounced,"subscribeViews"),u&&e.setEmptyView(_.isFunction(u)?u.call(e):u),o.elementLoader.build(e,t)},template:function(e,t){t.template&&e.setTemplate(t.template),o.elementLoader.build(e,t)}}}(),x=function(){function e(t,i){var o,u,l,c,a,h,b,v={};h=t;for(o in h)for(u=o.split(d),c=0,a=u.length;a>c;c++)l=u[c],l.indexOf(p)>=0&&(b=l.substring(0,1),(!i&&!_.contains(w,b)||b===i)&&(i&&(l=l.replace(i,"")),v[l]=r(h[o],v[l])));var f=s(t);return _.isEmpty(f)||n(v,e(f,i)),v}function i(e,t){var n,i,s,o,r,u,l,c,a,h,b,v,m=[];for(n in e)for(i=n.split(d),l=0,c=i.length;c>l;l++){if(u={},a=f.exec(i[l]),a&&a[2])for(o=a[1],s=a[2].split(d),h=0,b=s.length;b>h;h++)r=o+p+s[h],v=r.substring(0,1),(!t&&!_.contains(w,v)||v===t)&&(u.bindings||(u.bindings=[]),t&&(r=r.replace(t,"")),u.bindings.push(r));_.isEmpty(u)||(u.fn=_.isArray(e[n])?e[n]:[e[n]],m.push(u))}return m}function s(e){var t,n,i,s,o,u,l,c,a,h,b={};for(n in e)for(t=n.split(d),s=0,o=t.length;o>s;s++)if(i=v.exec(t[s]),i&&i[2])for(c=i[1],a=i[2].split(d),u=0,l=a.length;l>u;u++)h=c+p+a[u],b[h]=r(e[n],b[h]);return b}function r(e,t){var n=_.isArray(t)?t:[];return _.isArray(e)?n.push.apply(n,e):n.push(e),n}function u(e){var i,s,o,r,u,l={},c={},a=function(e,n){var s=u[r[i]];s[n]&&"bindings"!==n&&"eventsviews"!==n&&s[n]!==e&&t("ambigious merging of property: "+r[i])};for(o in e)for(r=o.split(d),u=1===r.length?l:c,i=0,s=r.length;s>i;i++)u[r[i]]?(_.each(e[o],a),u[r[i]]=n({},u[r[i]],e[o])):u[r[i]]=e[o];return n({},c,l)}function l(e){var t={},n=function(n){n[0],-1!==n.indexOf(p)||v.test(n)||f.test(n)||_.contains(g,n)||(t[n]=e[i])};for(var i in e)_.each(i.split(d),n);return t}function c(e){return _.isFunction(e)?e:_.isString(e)?function(){this[e].apply(this,arguments)}:(t("Not an acceptable value for an event method (must be a function or string"),void 0)}function a(t,n){var i=[];return _.each(e(t,n),function(e,t){var n=b(t);e=_.isArray(e)?e:[e],_.each(e,function(e){i.push(_.extend({fn:c(e)},n))})}),i}function h(e,t){var n=[];return _.each(i(e,t),function(e){var t={};t.bindings=_.map(e.bindings,b),t.fn=_.map(e.fn,c),n.push(t)}),n}function b(e){var t,n,i,s,o,r;return n=e.indexOf(p),s=e.substring(0,n),i=e.substring(n+1),i=i.split(":"),o=i[0],r=i[1],t={name:s,event:o,attribute:r}}var d=/\s+(?![^\[]*\]|[^\{]*\})/,v=/(.*?)\[(.*?)\]/,f=/(.*?)\{(.*?)\}/,p=".",m="*",w=["*"],g=["bind","subview","subviews","template","group","groups","collection","model","eventObjects","state","attr","el","defaults","elements","setup"];return{view:function(e,n){var i,s={},r={},l={},c={bind:{Constructor:o.DomValue,loader:o.domValueLoader},subview:{Constructor:o.ContainerView,loader:o.containerViewLoader},subviews:{Constructor:o.CollectionView,loader:o.collectionViewLoader},template:{Constructor:o.TemplateView,loader:o.templateViewLoader}},a=function(e){var n,i=0;return _.each(["subview","subviews","template","bind"],function(t){t in e&&(i++,n=_.extend({},c[t]),n.data=e)}),i>1?t("Only one of 'subview', 'subviews', 'template', 'bind' can exsist on an element"):0===i&&(n=_.extend({},c.bind),n.data=e),n};if(_.isObject(e))return i=_.extend({},o.elementLoader.parse(e),n),i.attr||(i.attr=o.defaultAttr),(e.defaults||o.defaultElement)&&(i.defaults=a(o.elementLoader.parse(e.defaults||o.defaultElement),n)),_.each(e.elements,function(e,t){_.isFunction(e)?l[t]={Constructor:e}:s[t]=o.elementLoader.parse(e,n)}),_.each(u(s),function(e,t){r[t]=a(e)}),s=_.extend(r,l),_.isEmpty(s)||(i.elements=s),i},element:function(e,t){var i={},s=e.group;if((_.isString(e)||_.isBoolean(e))&&(e={bind:e}),_.each(["template","attr","defaults"],function(t){void 0!==e[t]&&(i[t]=e[t])}),i.bindings=a(e),0===i.bindings.length&&delete i.bindings,i.bindingsDebounced=h(e),0===i.bindingsDebounced.length&&delete i.bindingsDebounced,i.eventsviews=a(e,m),0===i.eventsviews.length&&delete i.eventsviews,i.eventsviewsDebounced=h(e,m),0===i.eventsviewsDebounced.length&&delete i.eventsviewsDebounced,e.setup&&(i.setup=_.isArray(e.setup)?e.setup:[e.setup]),e.subviews){var r=_.isFunction(e.subviews)?{View:e.subviews}:e.subviews;i.subviews=r===!0?{}:_.extend({model:"model",collection:"collection"},r)}if(e.bind){var u,c={eventObject:"model",attribute:"{name}",domEvent:"change"},b=e.bind;_.isString(b)&&(u=b.split(p),b=u.length>1?{eventObject:u[0],attribute:u[1]}:{attribute:u[0]}),i.bind=b===!0?c:_.extend(c,b)}if(e.subview){var d=_.isFunction(e.subview)?{View:e.subview}:e.subview;i.subview=d===!0?{}:_.extend({synced:!0},d)}if(i.unknown=l(e),_.isEmpty(i.unknown)&&delete i.unknown,s&&t){var v=_.map(_.isArray(s)?s:[s],function(e){return t[e]?o.elementLoader.parse(t[e],t):{}});v.push(i),i=_.foldl(v,function(e,t){var i=t.unknown;return delete t.unknown,n(e,t),i&&(e.unknown=_.extend(e.unknown||{},i)),e},{})}return i}}}(),O=function(e,t){this._parse=e,this._builder=t};_.extend(O.prototype,{add:function(e,t){return(this._addons||(this._addons=[])).push({parse:e,builder:t}),this},parse:function(e,t){var n,i,s,o,r=this._parse(e,t);if(this._addons){for(n=0,i=this._addons.length;i>n;n++)s=this._addons[n].parse(e,t),void 0!==s&&(o||(o=[])).push({buildData:s,builder:this._addons[n].builder});o&&(r.addons=o)}return r},build:function(e,t){var n,i,s;if(this._builder(e,t),t.addons)for(s=t.addons,n=0,i=s.length;i>n;n++)s[n].builder(e,s[n].buildData)},clear:function(){return this._loaders=[],this}});var V=function(t,i){return function(r){r||(r={});var u,c,a,h=r.collection,b=r.state,d=r.model,v=r.groups,f=r.eventTypes?_.extend({},r.eventTypes):{},p=r.el||this.prototype._el;return h&&_.extend(f,{collection:h}),d&&_.extend(f,{model:d}),e(b)?(a=b,f.state=Backbone.Model):b&&(f.state=b),this.prototype._groups&&(v=_.extend({},this.prototype._groups,v)),u=i.parse(r,v?_.extend({},o._groups,v):o._groups),c=u.unknown||{},delete u.unknown,this.prototype._parsed&&(u=n({},this.prototype._parsed,u)),this.prototype.eventTypes&&(f=n({},this.prototype.eventTypes,f)),this.prototype._stateParams&&(a=_.extend({},this.prototype._stateParams,a)),l.call(this,_.extend({constructor:function(n){n||(n={});var r,u=_.extend({},o._globalEventObjects,n.eventObjects),l=n.el||this._el||"<div></div>",c=o.getEl(l),a=null==n.render?!0:n.render,h=this.eventTypes;n.collection&&(u.collection=s(n.collection,h.collection)),n.model&&(u.model=s(n.model,h.model)),n.state?u.state=e(n.state)?s(_.extend(this._stateParams,n.state),h.state):s(n.state,h.state):this._stateParams&&(u.state=s(this._stateParams,h.state)),t.call(this,{el:c}),i.build(this,this._parsed);for(r in u)this.set(r,u[r],{render:!1});this.initialize.apply(this,arguments);for(r in this.elements)this.elements[r].initialize.apply(this.elements[r],arguments);a&&this.render()},eventTypes:f,_stateParams:a,_parsed:u,_el:p,_groups:v},c))}};_.extend(o,{VERSION:"0.1.0",defaultAttr:"data-kettle",defaultElement:null,parsers:x,builders:y,elementLoader:new O(x.element,y.element),viewLoader:new O(x.view,y.view),domValueLoader:new O(x.element,y.domValue),collectionViewLoader:new O(x.element,y.collectionView),containerViewLoader:new O(x.element,y.containerView),templateViewLoader:new O(x.element,y.template),noConflict:function(){return r.Kettle=u,this},BBView:g,View:v,CollectionView:p,Element:d,ContainerView:m,DomValue:f,Loader:O,EventListeners:h,EventInterface:a,TemplateView:w,setGroup:function(e,t){o._groups[e]=t},getGroup:function(e){return o._groups[e]},deleteGroup:function(e){delete o._groups[e]},setGlobal:function(e){var n=d.prototype.mainEventObjects;_.extend(o._globalEventObjects,e),_.each(e,function(e,i){d.prototype[i]||v.prototype[i]||m.prototype[i]||p.prototype[i]||f.prototype[i]?t("can't set a global event object with name "+i+". it's reserved on an Object prototype"):_.contains(n,i)&&t("can't set a global event object with name "+i+". it's already contained in the main events. (perhaps it's already been set)"),n.push(i)})},getGlobal:function(e){return o._globalEventObjects[e]},getEl:function(e){var n,i=this._elCache;return _.isFunction(e)?e():_.isObject(e)?e:(_.isString(e)||t("Selector must be a string!"),i[e]?n=this._elCache[e]:(n={clone:!1},n.el=Backbone.$(e)[0],null==n.el&&t("Element not found with selector: "+e),"SCRIPT"===n.el.tagName&&(n.el=Backbone.$(c(n.el.innerHTML))[0],n.clone=!0),i[e]=n),n.clone?Backbone.$(n.el).clone()[0]:n.el)},_globalEventObjects:{},_elCache:{},_groups:{}}),d.extend=V(d,o.elementLoader),v.extend=V(v,o.viewLoader),p.extend=V(p,o.collectionViewLoader),m.extend=V(m,o.containerViewLoader),f.extend=V(f,o.domValueLoader),w.extend=V(w,o.templateViewLoader)}).call(this);