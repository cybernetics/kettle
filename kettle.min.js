// kettle-js v0.1.0 
// (c) 2013 Sergey Melnikov 

// kettle-js may be freely distributed under the MIT license


(function(){"use strict";function e(e){return e&&Object.prototype.hasOwnProperty.call(e.constructor.prototype,"hasOwnProperty")}function t(e){throw Error("Kettle : "+e)}function n(){var t,i,s,r,o=arguments[0];for(t=1,i=arguments.length;i>t;t++)for(s in arguments[t])r=arguments[t][s],e(r)?o[s]=n(_.isObject(o[s])?o[s]:{},r):_.isArray(r)?(_.isArray(o[s])||(o[s]=[]),o[s].push.apply(o[s],r)):o[s]=r;return o}function i(n,i){return e(n)||_.isArray(n)?_.isFunction(i)?new i(n):(t("No constructor set for event."),void 0):n}var s,r=this,o=r.Kettle,l=Backbone.Model.extend,u=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s+|\s+$/g)};s="undefined"!=typeof exports?exports:r.Kettle={};var a={init:function(){return Backbone.history.on("route",function(e,t,n){this._lastRoute={router:e,name:t,args:n}},this),this},bindEvent:function(e,t,n,i,s){e instanceof Backbone.$?e.on(n,this._proxy(i,t)):e.on(s?n+":"+s:n,i,t)},unbindEvent:function(e,t,n,i,s){e instanceof Backbone.$?i?e.off(n,this._unproxy(i,t)):e.off(n):e.off(s?n+":"+s:n,i,t)},bootstrap:function(e,t,n){e instanceof Backbone.Model?this._bootstrapModel(e,t,n):e instanceof Backbone.Collection?this._bootstrapCollection(e,t,n):e instanceof Backbone.Router&&this._bootstrapRouter(e,t,n)},_bootstrapModel:function(e,t,n){var i,s,r,o=e.collection,l={bootstrap:!0};if(n.change)for(i=0,s=n.change.length;s>i;i++)r=n.change[i],r.attribute?r.fn.call(t,e,e.attributes[r.attribute],l):r.fn.call(t,e,l);if(o&&n.add)for(i=0,s=n.add.length;s>i;i++)n.add[i].fn.call(t,e,o,l);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"change",e,l)},_bootstrapCollection:function(e,t,n){var i,s,r={bootstrap:!0};if(n.reset)for(i=0,s=n.reset.length;s>i;i++)n.reset[i].fn.call(t,e,r);if(n.all)for(i=0,s=n.all.length;s>i;i++)n.all[i].fn.call(t,"reset",e,r)},_bootstrapRouter:function(e,t,n){var i=this._lastRoute;e===i.router&&n.route&&_.each(n.route,function(e){e.attribute===i.name?e.fn.apply(t,i.args):null==e.attribute&&e.fn.call(t,i.router,i.name,i.args)})},_lastRoute:{},_fid:0,_proxies:{},_proxy_key:"__kettle_fid__",_proxy:function(e,t){var n,i=this._proxy_key;return null!=e[i]&&null!=t[i]&&(n=this._proxies[e[i]+" "+t[i]]),n||(n=_.bind(e,t),null!=e[i]||(e[i]=this._fid++),null!=t[i]||(t[i]=this._fid++),this._proxies[e[i]+" "+t[i]]=n),n},_unproxy:function(e,t){var n=this._proxy_key,i=e[n]+" "+t[n],s=this._proxies[i];return delete this._proxies[i],s}}.init(),c=function(e){this.eventObjects={},this.subscriptions={},this.context=e};_.extend(c.prototype,{add:function(e,t){var n,i=this.context;return this.eventObjects[e]||(this.eventObjects[e]=[]),n=this.eventObjects[e],n.push(t),_.each(this.subscriptions[e],function(e,n){_.each(e,function(e){a.bindEvent(t,i,n,e.fn,e.attribute)})}),this},bootstrap:function(){var e=this.eventObjects,t=this.context,n=0===arguments.length?this.subscriptions:_.pick(this.subscriptions,_.toArray(arguments));return _.each(n,function(n,i){_.each(e[i],function(e){a.bootstrap(e,t,n)})}),this},hasSubscription:function(e,t){return!(!this.subscriptions[e]||void 0!==t&&!this.subscriptions[e][t])},remove:function(e,t){var n,i,s,r=this.eventObjects[e];return r&&(s=_.indexOf(r,t),i=this.context,s>=0&&(r.splice(s,1),_.each(this.subscriptions[e],function(e,s){for(var r=0,o=e.length;o>r;r++)n=e[r],a.unbindEvent(t,i,s,n.fn,n.attribute)})),0===r.length&&delete this.eventObjects[e]),this},subscribe:function(e,t,n){var i,s,r=this.context,o=t.split(":");return t=o[0],i=o[1],this.subscriptions[e]||(this.subscriptions[e]={}),s=this.subscriptions[e],s[t]||(s[t]=[]),s[t].push({fn:n,attribute:i}),_.each(this.eventObjects[e],function(e){a.bindEvent(e,r,t,n,i)}),this},unsubscribe:function(e,t,n){var i,s,r,o,l,u,c,h=this.subscriptions,b=this.context,v=this.eventObjects;return t&&(c=t.split(":"),t=c[0],u=c[1]),_.each(h,function(c,d){e&&e!==d||(_.each(c,function(e,h){if(!t||h===t){for(i=0,s=e.length;s>i;i++){if(l=e[i],!(n&&n!==l.fn||t&&u&&u!==l.attribute))for(r=0,o=v[d].length;o>r;r++)a.unbindEvent(v[d][r],b,h,l.fn,l.attribute);e.splice(i,1),i--,s--}0===e.length&&delete c[h]}}),_.isEmpty(c)&&delete h[d])}),this}});var h=_.extend({_addViewEventObject:function(e){var t;return this._viewsubs||(this._viewsubs=new c(this)),t=this._viewsubs,this.stopListening(e,"change",this._onViewChange),this.listenTo(e,"change",this._onViewChange),_.each(t.subscriptions,function(n,i){e.eventObjects[i]&&t.add(i,e.eventObjects[i])}),this},hasSubscriptionViews:function(e,t){return!(!this._viewsubs||!this._viewsubs.hasSubscription(e,t))},_removeViewEventObject:function(e){var t=this._viewsubs;return t&&_.each(e.eventObjects,function(e,n){t.subscriptions[n]&&t.remove(n,e)}),this.stopListening(e,"change",this._onViewChange)},bootstrapViewSubscriptions:function(e){var t,n=this;return this._viewsubs&&(t=this._viewsubs.subscriptions,_.each(t,function(t,i){e.eventObjects[i]&&a.bootstrap(e.eventObjects[i],n,t)})),this},subscribeViews:function(e,t,n){var i,s;return this._viewsubs||(this._viewsubs=new c(this)),i=this._viewsubs,i.hasSubscription(e)||(s=this.subviews?this.subviews:this.subview?[this.subview]:[],_.each(s,function(t){t.eventObjects[e]&&i.add(e,t.eventObjects[e])})),this._viewsubs.subscribe(e,t,n),this},unsubscribeViews:function(e,t,n){return this._viewsubs&&this._viewsubs.unsubscribe(e,t,n),this},_stopListeningToViewEvents:function(){var e,t,n,i;if(this._viewsubs){e=this._viewsubs.eventObjects;for(i in e)for(t=0,n=e[i].length;n>t;t++)a.unbindEvent(e[i][t],this)}return this.stopListening(null,"change",this._onViewChange),this},_onViewChange:function(e,t,n,i){var s=this._viewsubs;s.subscriptions[t]&&(null!=i&&s.remove(t,i),null!=n&&(s.add(t,n),a.bootstrap(n,this,s.subscriptions[t])))}}),b=function(e){var t=e.el;t instanceof Backbone.$?(this.el=t[0],this.$el=t):(this.el=t,this.$el=Backbone.$(t)),this.eventObjects={el:this.$el,view:this},this._subs=new c(this).add("el",this.$el).add("view",this)};_.extend(b.prototype,Backbone.Events,{bootstrap:function(){return this._subs.bootstrap.apply(this._subs,arguments),this},initialize:function(){},get:function(e){return this.eventObjects[e]},remove:function(e){var t=e?e.silent:!1;return this.$el.remove(),this.unsubscribe(),t||this.trigger("remove",this),this.off().stopListening()},render:function(e){var t=e?e.silent:!1;return this.bootstrap(),t||this.trigger("render",this),this},set:function(e,n,i){var s=i?i.render:!0,r=i?i.silent:!1,o=this.eventObjects[e]||null,l=this._subs;return"el"===e&&n&&n!==this.$el&&t("cannot change eventObject 'el'"),!n||!this.eventTypes[e]||n instanceof this.eventTypes[e]||t("Invalid event object set, does not pass object validaiton"),this.eventObjects[e]=n,_.contains(this.mainEventObjects,e)&&(this[e]=n),o&&l.remove(e,o),n&&l.add(e,n),s!==!1&&n&&l.bootstrap(e),r||(this.trigger("change",this,e,n,o),this.trigger("change:"+e,this,n,o)),this},subscribe:function(e,t,n){return this._subs.subscribe(e,t,n),this},unset:function(e,t){return this.set(e,null,t)},unsubscribe:function(e,t,n){return this._subs.unsubscribe(e,t,n),this},mainEventObjects:["state","collection","model"],eventTypes:{},eventObjects:null,name:null,view:null,el:null,$el:null,_subs:null}),b.extend=function(){return l.call(this,_.extend.apply(this,[].slice.call(arguments,0).reverse()))};var v=b.extend({constructor:function(e){v.__super__.constructor.call(this,e),this.elements={}},addElement:function(e,n){(!_.isString(e)||this.elements[e])&&t("name invalid or taken"),n.view&&t("Element already owned by a view"),n.view=this;for(var i in this.eventObjects)"el"!==i&&n.set(i,this.eventObjects[i],{render:!1,silent:!0});return this.elements[e]=n,this},clear:function(e){return v.__super__.clear.call(this,e),_.each(this.elements,function(t){t.clear(e)}),this},remove:function(e){return v.__super__.remove.call(this,e),_.invoke(this.elements,"remove",{silent:!0}),this.elements=null,this},render:function(e){var t=e?e.silent:!1;return this.bootstrap(),_.invoke(this.elements,"render",{silent:!0}),t||this.trigger("render",this),this},removeElement:function(e){var n;return _.isString(e)&&(n=e,e=this.elements[e]),e.view!==this&&t("can't remove, Element not owned by this view"),n||_.each(this.elements,function(t,i){t===e&&(n=i)}),n&&delete this.elements[n],e.view=null,this},set:function(e,t,n){var i=_.extend({silent:!0},n);return v.__super__.set.call(this,e,t,n),_.each(this.elements,function(n){n.set(e,t,i)}),this},elements:null}),d=b.extend({constructor:function(e){d.__super__.constructor.call(this,e),this._findFn()},val:function(e){return arguments.length?(this._set(e),this):this._get()},_valGet:function(){return this.el.value},_valSet:function(e){this.el.value=e},_textGetIE:function(){return this.el.innerText},_textSetIE:function(e){this.el.innerText=e},_textGet:function(){return this.el.textContent},_textSet:function(e){this.el.textContent=e},_checkboxGet:function(){return!!this.el.checked},_checkboxSet:function(e){this.el.checked=!!e},_imgGet:function(){return this.el.src},_imgSet:function(e){this.el.src=e},_selectGet:function(){return this.$el.val()},_selectSet:function(e){this.$el.val(e)},_get:function(){},_set:function(){},_findFn:function(){var e=this.el.tagName,t=this.el.getAttribute("type");"INPUT"!==e||"radio"!==t&&"checkbox"!==t?"INPUT"===e||"TEXTAREA"===e||"SELECT"===e?(this._get=this._valGet,this._set=this._valSet):"IMG"===e?(this._get=this._imgGet,this._set=this._imgSet):void 0!==this.el.textContent?(this._get=this._textGet,this._set=this._textSet):(this._get=this._textGetIE,this._set=this._textSetIE):(this._get=this._checkboxGet,this._set=this._checkboxSet)}}),f=b.extend(h,{constructor:function(e){f.__super__.constructor.call(this,e),this.subviews=[]},addView:function(e,t){var n=this.subviews;return _.contains(n,e)?this.removeView(e).addView(e,t):(null!=t||(t=n.length),n.splice(t,0,e),e.on("remove",this.removeView,this),this._addViewEventObject(e),this.insert(e,t),this.emptyView&&this.emptyView.$el.detach(),this.bootstrapViewSubscriptions(e)),this},empty:function(){return this._stopListeningToViewEvents(),_.invoke(_.toArray(this.subviews),"remove"),this.subviews=[],this.emptyView&&this.$el.append(this.emptyView.$el),this},findWithEventObject:function(e,t){t||(t="model");for(var n=0,i=this.subviews.length;i>n;n++)if(this.subviews[n].eventObjects[t]===e)return this.subviews[n];return null},findWithElement:function(e){e instanceof Backbone.$&&(e=e[0]);for(var t=0,n=this.subviews.length;n>t;t++)if(this.subviews[t].el===e)return this.subviews[t];return null},insert:function(e,t){var n=this.el.childNodes;return n&&n.length&&n.length!==t?this.el.insertBefore(e.el,n[t]):this.el.appendChild(e.el),this},remove:function(){return this.empty(),f.__super__.remove.call(this),this.emptyView&&this.emptyview.remove(),this},removeView:function(e){var t=_.indexOf(this.subviews,e);return t>=0&&(this.subviews.splice(t,1),e.$el.detach(),this._removeViewEventObject(e),0===this.subviews.length&&this.emptyView&&this.$el.append(this.emptyView.$el)),this},setEmptyView:function(e){return this.emptyView=e,0===this.subviews.length&&this.$el.empty().append(this.emptyView.$el),this},bindToCollection:function(e,n,i){if(0!==this.subviews.length&&t("Cannot set target on a non-empty view collection"),this._target){var s=this._target.collection;this.unsubscribe(s,"add",this._onAdd).unsubscribe(s,"reset",this._onReset).unsubscribe(s,"remove",this._onRemove).unsubscribe(s,"sort",this._onSort)}this._target={collection:e,model:n,createView:i},this.subscribe(e,"add",this._onAdd).subscribe(e,"reset",this._onReset).subscribe(e,"remove",this._onRemove).subscribe(e,"sort",this._onSort)},_onAdd:function(e){var t=this._target.createView(e),n=this.eventObjects[this._target.collection],i=n.last()===e?null:_.indexOf(n,e);this.addView(t,i)},_onReset:function(){var e,t,n=this.eventObjects[this._target.collection],i=n.models,s={};for(this.empty(),e=0,t=i.length;t>e;e++)s.at=e,this._onAdd(i[e],s)},_onRemove:function(e){var t=this.findWithEventObject(e,this._target.model);this.removeView(t)},_onSort:function(){if(this.autoSort){var e,t,n,i,s=this.eventObjects[this._target.collection],r=s.models;for(e=0,t=r.length;t>e;e++)n=r[e],n!==this.subviews[e].eventObjects[this._target.model]&&(i=this.findWithEventObject(n,this._target.model),this.$el.children().eq(e).before(i.$el))}},_target:null,emptyView:null,subviews:null,autoSort:!0});_.each(["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],function(e){f.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this.subviews),_[e].apply(_,t)}});var p=b.extend(h,{constructor:function(e){p.__super__.constructor.call(this,e)},insert:function(e){return this.$el.append(e.$el),this},empty:function(){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),this},remove:function(){return this.empty(),p.__super__.remove.call(this),this},set:function(e,t,n){return this.subview&&this._synced&&"el"!==e&&"view"!==e&&this.subview.set(e,t),p.__super__.set.call(this,e,t,n)},setSubView:function(e,t){return this.subview&&(this._removeViewEventObject(this.subview),this.subview.remove()),e.el!==this.el&&this.insert(e),this._addViewEventObject(e),t&&_.each(this.eventObjects,function(t,n){"el"!==n&&"view"!==n&&t!==e.eventObjects[n]&&e.set(n,t)}),this._synced=t,this.subview=e,this.bootstrapViewSubscriptions(e),this},subview:null,_synced:!1}),m=b.extend({setTemplate:function(e){e===!0?(this._template=this.template(_.unescape(this.el.innerHTML)),this.el.innerHTML=""):this._template=_.isString(e)?this.template(Backbone.$(e).html()):e},render:function(){return this.el.innerHTML=this._template(this.serialize()),this},serialize:function(){return this.model.toJSON()},template:function(e){return _.template(e)},_template:null}),w=Backbone.View.extend({constructor:function(){Backbone.View.prototype.constructor.apply(this,arguments),this.eventObjects={},this.eventObjects.el=this.$el,this.eventObjects.view=this,this.model&&(this.eventObjects.model=this.model),this.collection&&(this.eventObjects.collection=this.collection)},get:function(e){return this.eventObjects[e]},set:function(e,t,n){var i=this.eventObjects[e];this.eventObjects[e]=t,"model"===e?this.model=t:"collection"===e&&(this.collection=t),null!=n&&n.silent||(this.trigger("change",this,e,t,i),this.trigger("change:"+e,this,t,i))},remove:function(){Backbone.View.prototype.remove.call(this),this.trigger("remove",this)},eventObjects:null}),g=function(){function e(e,t,n,i,s){o||(o=[],setTimeout(function(){_.each(o,function(e){e.obj[e.subFn](e.eventName,e.event,e.fn)}),o=null},0)),o.push({obj:e,subFn:t,fn:s,eventName:n,event:i})}function t(e,t){var n={},i="["+t+"]";return _.each(document.querySelectorAll?e[0].querySelectorAll(i):e.eq(0).find(i),function(e){n[e.getAttribute(t)]=e}),n}function n(t,n,i){var s,o,l,u,a;for(s=0,o=n.length;o>s;s++)l=n[s],u=l.attribute,u===r&&(u=t.name),"el"===l.name?e(t,i,l.name,l.event,l.fn):(a=u?l.event+":"+u:l.event,t[i](l.name,a,l.fn))}function i(t,n){var i,s,o,l,u,a=t.el.tagName;i=n.eventObject,s=n.attribute,o=n.domEvent,l=n.fromDOM?n.fromDOM(n):function(){this.eventObjects[i].set(s,this.val(),{origin:this.el})},u=n.fromModel?n.fromModel(n):function(e,t,n){n&&n.origin===this.el||this.val(null==t?"":t)},s===r&&(s=t.name),t.subscribe(i,"change:"+s,u),("INPUT"===a||"TEXTAREA"===a||"SELECT"===a)&&e(t,"subscribe","el",o,l)}var r="{name}",o=null;return{view:function(e,n){var i=n.attr,r=t(e.$el,i),o=n.defaults;_.each(n.elements,function(t,n){var i,s;i=r[n],i&&(delete r[n],s=new t.Constructor({el:i}),s.name=n,e.addElement(n,s),t.loader&&t.loader.build(s,t.data))}),o&&_.each(r,function(t,n){var i=new o.Constructor({el:t});i.name=n,e.addElement(n,i),o.loader.build(i,o.data)}),s.elementLoader.build(e,n)},element:function(e,t){if(t.unknown&&_.extend(e,t.unknown),t.bindings&&n(e,t.bindings,"subscribe"),t.setup)for(var i=t.setup,s=0,r=i.length;r>s;s++)i[s].call(e)},domValue:function(e,t){t.bind&&i(e,t.bind),s.elementLoader.build(e,t)},containerView:function(e,t){var i=t.subview||{},r=i.set,o=i.View,l=i.synced;t.eventsviews&&n(e,t.eventsviews,"subscribeViews"),o?e.setSubView(new o({render:!1}),l):r&&e.setSubView(_.isFunction(r)?r.call(e):r,l),s.elementLoader.build(e,t)},collectionView:function(e,t){var i,r=t.subviews||{},o=r.empty;r.create?i=r.create:r.View&&(i=function(e){var t={};return t[r.model]=e,new r.View({eventObjects:t})}),r.collection&&r.model&&i&&e.bindToCollection(r.collection,r.model,i),t.eventsviews&&n(e,t.eventsviews,"subscribeViews"),o&&e.setEmptyView(_.isFunction(o)?o.call(e):o),s.elementLoader.build(e,t)},template:function(e,t){t.template&&e.setTemplate(t.template),s.elementLoader.build(e,t)}}}(),y=function(){function e(t,s){var o,l,u,a,c,b,d={};b=t;for(o in b)for(l=o.split(h),a=0,c=l.length;c>a;a++)u=l[a],u.indexOf(v)>=0&&(s&&u.substring(0,s.length)!==s||(s&&(u=u.replace(s,"")),d[u]=r(b[o],d[u])));var f=i(t);return _.isEmpty(f)||n(d,e(f,s)),d}function i(e){var t,n,i,s,o,l,u,a,c,d,_={};for(n in e)for(t=n.split(h),s=0,o=t.length;o>s;s++)if(i=b.exec(t[s]),i&&i[2])for(a=i[1],c=i[2].split(h),l=0,u=c.length;u>l;l++)d=a+v+c[l],_[d]=r(e[n],_[d]);return _}function r(e,t){var n=_.isArray(t)?t:[];return _.isArray(e)?n.push.apply(n,e):n.push(e),n}function o(e){var i,s,r,o,l,u={},a={},c=function(e,n){var s=l[o[i]];s[n]&&"bindings"!==n&&"eventsviews"!==n&&s[n]!==e&&t("ambigious merging of property: "+o[i])};for(r in e)for(o=r.split(h),l=1===o.length?u:a,i=0,s=o.length;s>i;i++)l[o[i]]?(_.each(e[r],c),l[o[i]]=n({},l[o[i]],e[r])):l[o[i]]=e[r];return n({},a,u)}function l(e,t,n){var i,s,r;for(_.isArray(n)||(n=[n]),i=0,s=n.length;s>i;i++)r=n[i],void 0!==e[r]&&(t[r]=e[r])}function u(e,t,n){n&&(_.isArray(n)&&n.length||_.isObject(n)&&!_.isEmpty(n))&&(e[t]=n)}function a(e){var t={},n=function(n){n[0],-1!==n.indexOf(v)||b.test(n)||_.contains(f,n)||(t[n]=e[i])};for(var i in e)_.each(i.split(h),n);return t}function c(t,n){var i,s,r,o,l,u=[];return _.each(e(t,n?d:null),function(e,t){i=t.indexOf(v),r=t.substring(0,i),(n||r.substring(0,d.length)!==d)&&(s=t.substring(i+1),s=s.split(":"),o=s[0],l=s[1],_.isArray(e)?_.each(e,function(e){u.push({name:r,event:o,fn:e,attribute:l})}):u.push({name:r,event:o,fn:e,attribute:l}))}),u}var h=/\s+(?![^\[]*\])/,b=/(.*?)\[(.*?)\]/,v=".",d="*",f=["bind","subview","subviews","template","group","groups","collection","model","eventObjects","state","attr","el","defaults","elements","setup"];return{view:function(e,n){var i,r={},l={},u={},a={bind:{Constructor:s.DomValue,loader:s.domValueLoader},subview:{Constructor:s.ContainerView,loader:s.containerViewLoader},subviews:{Constructor:s.CollectionView,loader:s.collectionViewLoader},template:{Constructor:s.TemplateView,loader:s.templateViewLoader}},c=function(e){var n,i=0;return _.each(["subview","subviews","template","bind"],function(t){t in e&&(i++,n=_.extend({},a[t]),n.data=e)}),i>1?t("Only one of 'subview', 'subviews', 'template', 'bind' can exsist on an element"):0===i&&(n=_.extend({},a.bind),n.data=e),n};if(_.isObject(e))return i=_.extend({},s.elementLoader.parse(e),n),i.attr||(i.attr=s.defaultAttr),(e.defaults||s.defaultElement)&&(i.defaults=c(s.elementLoader.parse(e.defaults||s.defaultElement),n)),_.each(e.elements,function(e,t){_.isFunction(e)?u[t]={Constructor:e}:r[t]=s.elementLoader.parse(e,n)}),_.each(o(r),function(e,t){l[t]=c(e)}),r=_.extend(l,u),_.isEmpty(r)||(i.elements=r),i},element:function(e,t){var i={},r=e.group;if((_.isString(e)||_.isBoolean(e))&&(e={bind:e}),l(e,i,["template","attr","defaults"]),u(i,"bindings",c(e)),u(i,"eventsviews",c(e,!0)),e.setup&&(i.setup=_.isArray(e.setup)?e.setup:[e.setup]),e.subviews){var o=_.isFunction(e.subviews)?{View:e.subviews}:e.subviews;i.subviews=o===!0?{}:_.extend({model:"model",collection:"collection"},o)}if(e.bind){var h,b={eventObject:"model",attribute:"{name}",domEvent:"change"},d=e.bind;_.isString(d)&&(h=d.split(v),d=h.length>1?{eventObject:h[0],attribute:h[1]}:{attribute:h[0]}),i.bind=d===!0?b:_.extend(b,d)}if(e.subview){var f=_.isFunction(e.subview)?{View:e.subview}:e.subview;i.subview=f===!0?{}:_.extend({synced:!0},f)}if(u(i,"unknown",a(e)),r&&t){var p=_.map(_.isArray(r)?r:[r],function(e){return t[e]?s.elementLoader.parse(t[e],t):{}});p.push(i),i=_.foldl(p,function(e,t){var i=t.unknown;return delete t.unknown,n(e,t),i&&(e.unknown=_.extend(e.unknown||{},i)),e},{})}return i}}}(),x=function(e,t){this._parse=e,this._builder=t};_.extend(x.prototype,{add:function(e,t){return(this._addons||(this._addons=[])).push({parse:e,builder:t}),this},parse:function(e,t){var n,i,s,r,o=this._parse(e,t);if(this._addons){for(n=0,i=this._addons.length;i>n;n++)s=this._addons[n].parse(e,t),void 0!==s&&(r||(r=[])).push({buildData:s,builder:this._addons[n].builder});r&&(o.addons=r)}return o},build:function(e,t){var n,i,s;if(this._builder(e,t),t.addons)for(s=t.addons,n=0,i=s.length;i>n;n++)s[n].builder(e,s[n].buildData)},clear:function(){return this._loaders=[],this}});var O=function(t,r){return function(o){o||(o={});var u,a,c,h=o.collection,b=o.state,v=o.model,d=o.groups,f=o.eventTypes?_.extend({},o.eventTypes):{},p=o.el||this.prototype._el;return h&&_.extend(f,{collection:h}),v&&_.extend(f,{model:v}),e(b)?(c=b,f.state=Backbone.Model):b&&(f.state=b),this.prototype._groups&&(d=_.extend({},this.prototype._groups,d)),u=r.parse(o,d?_.extend({},s._groups,d):s._groups),a=u.unknown||{},delete u.unknown,this.prototype._parsed&&(u=n({},this.prototype._parsed,u)),this.prototype.eventTypes&&(f=n({},this.prototype.eventTypes,f)),this.prototype._stateParams&&(c=_.extend({},this.prototype._stateParams,c)),l.call(this,_.extend({constructor:function(n){n||(n={});var o,l=_.extend({},s._globalEventObjects,n.eventObjects),u=n.el||this._el||"<div></div>",a=s.getEl(u),c=null==n.render?!0:n.render,h=this.eventTypes;n.collection&&(l.collection=i(n.collection,h.collection)),n.model&&(l.model=i(n.model,h.model)),n.state?l.state=e(n.state)?i(_.extend(this._stateParams,n.state),h.state):i(n.state,h.state):this._stateParams&&(l.state=i(this._stateParams,h.state)),t.call(this,{el:a}),r.build(this,this._parsed);for(o in l)this.set(o,l[o],{render:!1});this.initialize.apply(this,arguments);for(o in this.elements)this.elements[o].initialize.apply(this.elements[o],arguments);c&&this.render()},eventTypes:f,_stateParams:c,_parsed:u,_el:p,_groups:d},a))}};_.extend(s,{VERSION:"0.1.0",defaultAttr:"data-kettle",defaultElement:null,parsers:y,builders:g,elementLoader:new x(y.element,g.element),viewLoader:new x(y.view,g.view),domValueLoader:new x(y.element,g.domValue),collectionViewLoader:new x(y.element,g.collectionView),containerViewLoader:new x(y.element,g.containerView),templateViewLoader:new x(y.element,g.template),noConflict:function(){return r.Kettle=o,this},BBView:w,View:v,CollectionView:f,Element:b,ContainerView:p,DomValue:d,Loader:x,EventListeners:c,EventInterface:a,TemplateView:m,setGroup:function(e,t){s._groups[e]=t},getGroup:function(e){return s._groups[e]},deleteGroup:function(e){delete s._groups[e]},setGlobal:function(e){var n=b.prototype.mainEventObjects;_.extend(s._globalEventObjects,e),_.each(e,function(e,i){b.prototype[i]||v.prototype[i]||p.prototype[i]||f.prototype[i]||d.prototype[i]?t("can't set a global event object with name "+i+". it's reserved on an Object prototype"):_.contains(n,i)&&t("can't set a global event object with name "+i+". it's already contained in the main events. (perhaps it's already been set)"),n.push(i)})},getGlobal:function(e){return s._globalEventObjects[e]},getEl:function(e){var n,i=this._elCache;return _.isFunction(e)?e():_.isObject(e)?e:(_.isString(e)||t("Selector must be a string!"),i[e]?n=this._elCache[e]:(n={clone:!1},n.el=Backbone.$(e)[0],null==n.el&&t("Element not found with selector: "+e),"SCRIPT"===n.el.tagName&&(n.el=Backbone.$(u(n.el.innerHTML))[0],n.clone=!0),i[e]=n),n.clone?Backbone.$(n.el).clone()[0]:n.el)},_globalEventObjects:{},_elCache:{},_groups:{}}),b.extend=O(b,s.elementLoader),v.extend=O(v,s.viewLoader),f.extend=O(f,s.collectionViewLoader),p.extend=O(p,s.containerViewLoader),d.extend=O(d,s.domValueLoader),m.extend=O(m,s.templateViewLoader)}).call(this);